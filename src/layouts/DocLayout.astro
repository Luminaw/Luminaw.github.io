---
import BaseLayout from "./BaseLayout.astro";
import { getCollection } from "astro:content";

const { title, entry } = Astro.props;

// entry.id in Astro 5 is the relative path from the content dir, e.g., "luminaw/index.mdx"
const cleanEntryId = entry.id.replace(/\.mdx?$/, "");
const projectRoot = cleanEntryId.split("/")[0];

const allDocs = await getCollection("docs");

// Filter docs that belong to the same project
const projectDocs = allDocs
    .filter((doc) => doc.id.startsWith(projectRoot))
    .sort((a, b) => a.data.sidebarOrder - b.data.sidebarOrder);

// Helper to format the link correctly
const getDocLink = (id: string) => {
    const cleanId = id.replace(/\.mdx?$/, "");
    const finalId = cleanId.endsWith("/index")
        ? cleanId.replace("/index", "")
        : cleanId;
    return `/docs/${finalId}`;
};
---

<BaseLayout title={title}>
    <div
        class="flex flex-col lg:flex-row gap-12 max-w-7xl mx-auto px-4 lg:px-8"
    >
        <aside class="w-full lg:w-64 shrink-0 space-y-8 py-8">
            <a
                href="/docs"
                class="inline-flex items-center text-xs font-bold uppercase tracking-widest text-mauve hover:opacity-80 transition-opacity mb-2"
            >
                ‚Üê Back to Projects
            </a>

            <div>
                <h5
                    class="text-[10px] font-black uppercase tracking-[0.2em] text-overlay0 mb-4 px-3 opacity-50"
                >
                    {projectRoot.charAt(0).toUpperCase() + projectRoot.slice(1)} Navigation
                </h5>
                <nav>
                    <ul class="space-y-1">
                        {
                            projectDocs.map((doc) => (
                                <li>
                                    <a
                                        href={getDocLink(doc.id)}
                                        class={`block px-3 py-2 text-sm transition-all border-l-2 ${
                                            entry?.id === doc.id
                                                ? "bg-mauve/10 text-mauve border-mauve font-bold"
                                                : "text-subtext0 border-transparent hover:text-text hover:border-surface1"
                                        }`}
                                    >
                                        {doc.data.title}
                                    </a>
                                </li>
                            ))
                        }
                    </ul>
                </nav>
            </div>
        </aside>

        <article
            class="flex-1 min-w-0 py-8 prose prose-invert prose-mauve max-w-none"
        >
            <div
                class="bg-mantle/50 border border-surface0 p-8 md:p-12"
                style="border-radius: var(--radius-sm);"
            >
                <h1 class="not-prose text-4xl font-black tracking-tight mb-8">
                    {title}
                </h1>
                <slot />
            </div>
        </article>
    </div>
</BaseLayout>

<style is:global>
    .prose pre {
        background-color: var(--color-crust) !important;
        border: 1px solid var(--color-surface0);
        border-radius: var(--radius-sm);
        padding: 1.5rem;
    }
    .prose code {
        font-family: "JetBrains Mono", monospace;
        font-size: 0.9em;
    }
</style>
