---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Card from "../../components/common/Card.astro";
import { getCollection } from "astro:content";

const posts = await getCollection("blog", ({ data }) => !data.draft);
const sortedPosts = posts.sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// Get unique tags
const allTags = [
    ...new Set(sortedPosts.flatMap((post) => post.data.tags || [])),
];
---

<BaseLayout
    title="Blog | Luminaw | Engineering & Systems"
    description="Deep dives into software engineering, systems programming, and low-level architecture."
>
    <div class="space-y-12">
        <header class="space-y-4">
            <h1
                class="text-4xl md:text-5xl font-black tracking-tight text-text"
            >
                Writing
            </h1>
            <p class="text-subtext1 text-xl max-w-2xl leading-relaxed">
                Personal thoughts, technical tutorials, and reflections on
                building software.
            </p>
        </header>

        <div class="flex flex-wrap gap-2">
            <button
                class="tag-filter px-3 py-1 bg-surface0 text-subtext1 text-xs font-bold uppercase tracking-widest transition-all hover:bg-surface1"
                data-tag-filter="all"
                style="border-radius: var(--radius-xs);"
            >
                All
            </button>
            {
                allTags.map((tag) => (
                    <button
                        class="tag-filter px-3 py-1 bg-surface0 text-subtext1 text-xs font-bold uppercase tracking-widest transition-all hover:bg-surface1"
                        data-tag-filter={tag.toLowerCase()}
                        style="border-radius: var(--radius-xs);"
                    >
                        {tag}
                    </button>
                ))
            }
        </div>

        <div class="grid gap-8 blog-posts-container">
            {
                sortedPosts.map((post) => {
                    const postSlug = post.id.replace(/\.mdx?$/, "");
                    return (
                        <Card
                            title={post.data.title}
                            description={post.data.description}
                            href={`/blog/${postSlug}`}
                            date={post.data.pubDate.toLocaleDateString(
                                "en-US",
                                {
                                    month: "long",
                                    day: "numeric",
                                    year: "numeric",
                                    timeZone: "UTC",
                                },
                            )}
                            tags={post.data.tags}
                        />
                    );
                })
            }
        </div>
    </div>

    <script is:inline>
        function setupTagFiltering() {
            const filters = document.querySelectorAll(".tag-filter");
            const cards = document.querySelectorAll(".blog-card");
            const allBlogTags = document.querySelectorAll(".blog-tag");

            function updateSelection(selectedTag) {
                const tag = selectedTag.toLowerCase();

                // Update URL
                const url = new URL(window.location);
                if (tag === "all") {
                    url.searchParams.delete("tag");
                } else {
                    url.searchParams.set("tag", tag);
                }
                window.history.replaceState({}, "", url);

                // Update Top Level Buttons
                filters.forEach((btn) => {
                    if (btn.getAttribute("data-tag-filter") === tag) {
                        btn.classList.add("tag-active");
                    } else {
                        btn.classList.remove("tag-active");
                    }
                });

                // Update Card Tags (Mirroring)
                allBlogTags.forEach((bt) => {
                    if (bt.getAttribute("data-tag") === tag) {
                        bt.classList.add("tag-active");
                    } else {
                        bt.classList.remove("tag-active");
                    }
                });

                // Filter Cards
                cards.forEach((card) => {
                    if (tag === "all") {
                        card.classList.remove("blog-card-hidden");
                        return;
                    }

                    const cardTags = card.getAttribute("data-tags").split(",");
                    if (cardTags.includes(tag)) {
                        card.classList.remove("blog-card-hidden");
                    } else {
                        card.classList.add("blog-card-hidden");
                    }
                });
            }

            // Handle Top Level Filter Clicks
            filters.forEach((btn) => {
                btn.addEventListener("click", () => {
                    const tag = btn.getAttribute("data-tag-filter");
                    updateSelection(tag);
                });
            });

            // Handle Card Tag Clicks
            allBlogTags.forEach((bt) => {
                bt.addEventListener("click", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const tag = bt.getAttribute("data-tag");
                    updateSelection(tag);
                });
            });

            // Initial Filter from URL
            const urlParams = new URLSearchParams(window.location.search);
            const activeTag = urlParams.get("tag") || "all";
            updateSelection(activeTag);
        }

        // Initialize on load
        setupTagFiltering();
    </script>
</BaseLayout>
